# Prompt Governor - Docker Compose Configuration
# Phase A2: Docker Compose Configuration
# =============================================================
# This configuration enables:
# - Hot reload for development
# - Volume mounts for data persistence and code sharing
# - Environment variable injection from .env file
# - Port mapping for local access
# =============================================================

services:
  prompt-governor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prompt-governor
    ports:
      - "8000:8000"
    volumes:
      # External prompt optimization codebase (read-only)
      # Mounts existing codebase for reuse without copying
      - ~/Documents/projects/prompt_optimization:/app/prompt_optimization:ro
      
      # Data persistence directories
      - ./data:/app/data
      - ./documents:/app/documents:ro
      - ./ground_truth:/app/ground_truth:ro
      - ./cache:/app/cache
      
      # Live reload for development
      # Mounts local mvp/ directory for hot reload
      - ./mvp:/app/mvp
      - ./static:/app/static
    environment:
      # Load all environment variables from .env file
      # This includes API keys and configuration
      # PYTHONPATH includes /app (MVP code) and /app/prompt_optimization (pipeline code)
      - PYTHONPATH=/app:/app/prompt_optimization
    env_file:
      - .env
    # Override the default command to enable hot reload
    # and point to the mvp package
    command: uvicorn mvp.main:app --host 0.0.0.0 --port 8000 --reload
    # Restart policy for development
    restart: unless-stopped
    # Health check to ensure service is running
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
